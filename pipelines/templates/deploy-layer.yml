# Template: Deploy a single layer
# Combines init, plan, and apply for one layer
#
# This template:
# 1. Computes the backend config from bootstrap_subscription_id (matching stamp module logic)
# 2. Initializes Terraform with remote state from Azure Storage
# 3. Plans changes using existing state (idempotent)
# 4. Applies changes
#
# For multi-subscription deployments:
# - subscriptionId: where stamp resources are deployed
# - bootstrapSubscriptionId: where Terraform state backend lives (defaults to subscriptionId)

parameters:
  - name: layer
    type: string
  - name: layerFolder
    type: string
  - name: stampId
    type: string
  - name: subscriptionId
    type: string
  - name: bootstrapSubscriptionId
    type: string
    default: ''
  - name: serviceConnection
    type: string
  - name: dependsOn
    type: object
    default: []

jobs:
  - job: Deploy_${{ replace(parameters.layer, '-', '_') }}
    displayName: 'Deploy ${{ parameters.layer }}'
    dependsOn: ${{ parameters.dependsOn }}
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - checkout: self

      - task: TerraformInstaller@1
        displayName: 'Install Terraform'
        inputs:
          terraformVersion: 'latest'

      - template: terraform-init.yml
        parameters:
          workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/layers/${{ parameters.layerFolder }}'
          stampId: ${{ parameters.stampId }}
          layer: ${{ parameters.layer }}
          serviceConnection: ${{ parameters.serviceConnection }}
          subscriptionId: ${{ parameters.subscriptionId }}
          bootstrapSubscriptionId: ${{ parameters.bootstrapSubscriptionId }}

      - task: AzureCLI@2
        displayName: 'Terraform Plan & Apply - ${{ parameters.layer }}'
        inputs:
          azureSubscription: ${{ parameters.serviceConnection }}
          scriptType: 'bash'
          scriptLocation: 'inlineScript'
          inlineScript: |
            set -e
            
            # Determine bootstrap subscription (for passing to stamp module)
            BOOTSTRAP_SUB="${{ parameters.bootstrapSubscriptionId }}"
            if [ -z "$BOOTSTRAP_SUB" ]; then
              BOOTSTRAP_SUB="${{ parameters.subscriptionId }}"
            fi
            
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ“‹ Planning ${{ parameters.layer }} for stamp ${{ parameters.stampId }}"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
            terraform plan \
              -var="subscription_id=${{ parameters.subscriptionId }}" \
              -var="stamp_id=${{ parameters.stampId }}" \
              -var="bootstrap_subscription_id=${BOOTSTRAP_SUB}" \
              -out=tfplan \
              -input=false
            
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸš€ Applying ${{ parameters.layer }}"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
            terraform apply -auto-approve -input=false tfplan
            
            echo ""
            echo "âœ… ${{ parameters.layer }} deployed successfully"
          addSpnToEnvironment: true
          workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/layers/${{ parameters.layerFolder }}'
