# Azure DevOps Pipeline: Destroy Stamp
#
# Destroys a stamp's infrastructure.
# Use with caution - this is destructive!

trigger: none
pr: none

parameters:
  - name: stampId
    displayName: 'Stamp to destroy'
    type: string
    default: 'swc-dev'
    values:
      - swc-dev
      - swc-staging
      - swc-prod
      - neu-dev
      - neu-prod

  - name: layers
    displayName: 'Layers to destroy (reverse order)'
    type: object
    default:
      - 04-compute
      - 02-shared
      - 01-networking

  - name: confirmDestroy
    displayName: 'Type the stamp ID to confirm destruction'
    type: string
    default: ''

variables:
  - group: stamp-common
  - name: serviceConnection
    value: 'azure-infra-dev'

stages:
  - stage: Validate
    displayName: 'Validate Destruction'
    jobs:
      - job: CheckConfirmation
        displayName: 'Verify Confirmation'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: |
              if [ "${{ parameters.confirmDestroy }}" != "${{ parameters.stampId }}" ]; then
                echo "âŒ ERROR: Confirmation does not match stamp ID"
                echo ""
                echo "You entered: '${{ parameters.confirmDestroy }}'"
                echo "Expected:    '${{ parameters.stampId }}'"
                echo ""
                echo "To destroy the stamp, enter the stamp ID in the confirmation field."
                exit 1
              fi
              
              echo "âœ… Confirmation verified: destroying ${{ parameters.stampId }}"
            displayName: 'Verify Confirmation'

  - stage: Destroy
    displayName: 'Destroy Stamp'
    dependsOn: Validate
    jobs:
      - deployment: DestroyInfra
        displayName: 'Destroy ${{ parameters.stampId }}'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'destroy-approval'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - template: templates/install-terraform.yml
                  parameters:
                    version: '1.13.5'

                - task: AzureCLI@2
                  displayName: 'Destroy Layers'
                  inputs:
                    azureSubscription: $(serviceConnection)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      set -e
                      
                      STAMP_ID="${{ parameters.stampId }}"
                      SUBSCRIPTION_ID=$(SUBSCRIPTION_ID)
                      
                      # Get backend config
                      cd terraform/modules/stamp
                      terraform init -input=false > /dev/null
                      BACKEND=$(terraform output -json backend 2>/dev/null)
                      cd ../../..
                      
                      BACKEND_RG=$(echo $BACKEND | jq -r ".resource_group_name")
                      BACKEND_SA=$(echo $BACKEND | jq -r ".storage_account_name")
                      BACKEND_CONTAINER=$(echo $BACKEND | jq -r ".container_name")
                      
                      # Convert layers parameter to array
                      LAYERS="${{ join(',', parameters.layers) }}"
                      
                      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                      echo "ğŸ—‘ï¸  DESTROYING STAMP: $STAMP_ID"
                      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                      echo "Layers to destroy: $LAYERS"
                      echo ""
                      
                      IFS=',' read -ra LAYER_ARRAY <<< "$LAYERS"
                      
                      for layer in "${LAYER_ARRAY[@]}"; do
                        layer=$(echo "$layer" | xargs)  # trim whitespace
                        
                        echo ""
                        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                        echo "ğŸ—‘ï¸  Destroying: $layer"
                        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                        
                        cd terraform/layers/$layer
                        
                        terraform init \
                          -backend-config="resource_group_name=$BACKEND_RG" \
                          -backend-config="storage_account_name=$BACKEND_SA" \
                          -backend-config="container_name=$BACKEND_CONTAINER" \
                          -backend-config="key=$STAMP_ID/${layer#*-}.tfstate" \
                          -input=false
                        
                        terraform destroy \
                          -var="subscription_id=$SUBSCRIPTION_ID" \
                          -var="stamp_id=$STAMP_ID" \
                          -auto-approve \
                          -input=false
                        
                        echo "âœ… $layer destroyed"
                        
                        cd ../../..
                      done
                      
                      echo ""
                      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                      echo "âœ… STAMP DESTROYED: $STAMP_ID"
                      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    addSpnToEnvironment: true
